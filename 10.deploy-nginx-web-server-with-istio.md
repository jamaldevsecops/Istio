# üöÄ Deploy Nginx Web Server in Kubernetes with Istio Ingress (HTTPS)
 
  üìå Overview
This guide walks you through:
    1. Namespace creation
    2. Sidecar Injection
    3. TLS secret setup
    4. DNS configuration
    5. Deployment, Service, HPA
    6. Istio Gateway & VirtualService
    7. Verification checklist

## 1Ô∏è‚É£ Create Namespace
```bash
kubectl create namespace nginx-app
```

## üîÑ Enable Istio Sidecar Injection in nginx-app Namespace
```bash
kubectl label namespace nginx-app istio-injection=enabled
```
Verify Sidecar Injection Label on Namespace
```bash
kubectl get namespace nginx-app --show-labels
```

## 2Ô∏è‚É£ Prepare and Create TLS Secret
Ensure you have:
    * CA_chain.crt ‚Äì Your full certificates chain which includes 'Your main cert of the domain' > 'Any intermediate cert(s) > 'Root cert' in order. 
    * apsissolutions.com.key ‚Äì Your private key

Then create the secret in the ```nginx-app``` namespace:
```bash
kubectl create secret tls apsis-tls \
  --cert=/home/ops/2025/CA_chain.crt \
  --key=/home/ops/2025/apsissolutions.com.key \
  -n nginx-app
```
Verify TLS Secret
```bash
kubectl get secret apsis-tls -n nginx-app
```

## 3Ô∏è‚É£ Configure DNS
1. Verify Istio Ingress Gateway Service & External IP
```bash
kubectl get svc istio-ingressgateway -n istio-system
```
2. Get the Istio Ingress Gateway‚Äôs external IP:
```bash
kubectl get svc istio-ingressgateway -n istio-system
```
3. Create a DNS A record pointing ```mynginx.apsissolutions.com``` to the EXTERNAL-IP above.

## üì¶ 1. Deployment
Description:
Deploys 2 replicas of Nginx (nginx:1.20) with defined CPU and memory resource requests and limits. Uses a rolling update strategy with minReadySeconds to improve rollout stability.
YAML:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  namespace: nginx-app
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 20%
      maxSurge: 30%
  minReadySeconds: 10
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.20
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
```
Apply the Deployment:
```bash
kubectl apply -f nginx-deployment.yaml
```
Verify Deployment
```bash
kubectl get deployment nginx-deployment -n nginx-app
kubectl describe deployment nginx-deployment -n nginx-app
kubectl get pods -n nginx-app -l app=nginx
```

## üîÅ 2. Service
Description:
A ClusterIP service that exposes the Nginx pods internally on port 80, allowing Istio to route traffic to it.
YAML:
```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
  namespace: nginx-app
spec:
  type: ClusterIP
  selector:
    app: nginx
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
```
Apply the Service:
```bash
kubectl apply -f nginx-service.yaml
```
Verify Service
```bash
kubectl get svc nginx-service -n nginx-app
kubectl describe svc nginx-service -n nginx-app
```

## üìà 3. Horizontal Pod Autoscaler (HPA)
Description:
Automatically scales the number of Nginx pods between 5 and 20 based on CPU utilization. Targets 70% CPU usage per pod.
YAML:
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: nginx-hpa
  namespace: nginx-app
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: nginx-deployment
  minReplicas: 5
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
```
Apply the HPA:
```bash
kubectl apply -f nginx-hpa.yaml
```
Verify Horizontal Pod Autoscaler (HPA)
```bash
kubectl get hpa nginx-hpa -n nginx-app
kubectl describe hpa nginx-hpa -n nginx-app
```

## üåâ 4. Istio Gateway
Description:
Exposes HTTPS traffic on port 443 for the host mynginx.apsissolutions.com, using the TLS secret apsis-tls.
YAML:
```yaml
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: nginx-gateway
  namespace: nginx-app
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 443
      name: https
      protocol: HTTPS
    tls:
      mode: SIMPLE
      credentialName: apsis-tls
    hosts:
    - "mynginx.apsissolutions.com"
```
Apply the Gateway:
```bash
kubectl apply -f nginx-gateway.yaml
```
Verify Istio Gateway
```bash
kubectl get gateway nginx-gateway -n nginx-app
kubectl describe gateway nginx-gateway -n nginx-app
```


## üß≠ 5. Istio VirtualService
Description:
Routes external traffic from the Gateway to the internal Nginx service on port 80.
YAML:
```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: nginx-vs
  namespace: nginx-app
spec:
  hosts:
  - "mynginx.apsissolutions.com"
  gateways:
  - nginx-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: nginx-service.nginx-app.svc.cluster.local
        port:
          number: 80
```
Apply the VirtualService:
```bash
kubectl apply -f nginx-virtualservice.yaml
```
Verify Istio VirtualService
```bash
kubectl get virtualservice nginx-vs -n nginx-app
kubectl describe virtualservice nginx-vs -n nginx-app
```

## ‚úÖ Final Steps
1. Ensure the TLS secret (apsis-tls) exists in the nginx-app namespace.
2. Point the domain mynginx.apsissolutions.com to the external IP of the Istio Ingress Gateway.
3. Access the app at: 
```plain
https://mynginx.apsissolutions.com
```

